---
title: "Travel time estimates"
author: "Harald Kliems"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(reactable)
library(ggplot2)
library(tmap)
library(sf)
library(gt)

theme_set(theme_minimal())
```

```{r}
travel_time <- readRDS("data/data_clean.RDS")

decode_polyline <- function(polyline_string) {

  # Decode the polyline to get lat/lng coordinates
  coords <- googlePolylines::decode(polyline_string)
  coords <- coords[[1]]

    # Create an sf LINESTRING object
linestring <- st_linestring(as.matrix(coords[, c("lon", "lat")]))

return(list(linestring))
}

```


# John Nolen Corridor
These travel time estimates are for the John Nolen Drive (JND) corridor between Rimrock and the "Hairball" (JND/Wilson/Willy/Blair). 

```{r}
jnd <- travel_time |> 
  filter(route_id == "John Nolen Dr (Rimrock <-> Hairball)") 
```


```{r}
tmap_mode("view")
jnd |> 
  rowwise() |> 
  mutate(linestring = decode_polyline(polyline)) |> 
  st_as_sf(sf_column_name = "linestring") |> 
  tm_shape() +
  tm_lines(col = "direction", col_alpha = 0.03)
```

## Travel time estimates
Travel time estimates in a sortable and filterable table:
```{r}
jnd |> 
  mutate(duration_minutes = round(duration_minutes, 1),
         static_duration = round(static_duration/60, 1)) |> 
  select(request_time_local, direction, distance_miles, duration_minutes, static_duration, day_of_week, weekend) |> 
  reactable(filterable = TRUE,
            columns = list(
    request_time_local = colDef(name = "Date/time", format = colFormat(datetime = TRUE)),
    distance_miles = colDef(name = "Distance (miles)", format = colFormat(digits = 1)),
    duration_minutes = colDef(name = "Travel time (minutes)"),
    static_duration = colDef(name = "Typical travel time (minutes)"),
    day_of_week = colDef(name = "Day of week"),
    weekend = colDef(name = "Weekend"),
    direction = colDef(name = "Direction")))
```

### Summary statistics

```{r}
percentiles <- jnd |> 
  group_by(direction) |> 
  summarise(
          mean = mean(duration_minutes),
          median = median(duration_minutes),
          min = min(duration_minutes),
          max = max(duration_minutes),
          duration_5_pct = quantile(duration_minutes, c(0.05)),
          duration_95_pct = quantile(duration_minutes, c(0.95))) |> 
  mutate(duration_90 = paste0(round(duration_5_pct, 1), "-", round(duration_95_pct,1 )))

percentiles |> 
  select(-duration_5_pct, -duration_95_pct) |> 
  gt() |> 
  fmt_number(columns = where(is.numeric), decimals = 1) |> 
  tab_header(title = "Estimated travel times on JND (minutes)") |> 
  cols_label(direction = "Direction",
             mean = "Mean",
             median = "Median",
             min = "Minimum",
             max = "Maximum",
             duration_90 = "90% of trips"
             )
```


### Travel time plots
```{r}
travel_time |> 
  filter(route_id == "John Nolen Dr (Rimrock <-> Hairball)") |> 
  ggplot(aes(request_time_UTC, duration_minutes, color = direction)) +
  geom_point() +
  scale_x_datetime(timezone = "US/Central", date_minor_breaks = "3 hours", name = "Date/time") +
  ylab("Estimated travel time (minutes)") +
  facet_wrap(~ weekend)
```


This plot shows the median travel time (middle line), the 25th and 75th percentile (interquartile range; box), 1.5 times the interquartile range (whiskers).
```{r}
travel_time |> 
   filter(route_id == "John Nolen Dr (Rimrock <-> Hairball)") |> 
  ggplot(aes(direction, duration_minutes)) +
  geom_boxplot(outliers = FALSE)+
  geom_jitter(aes(color = weekend), width = .2) +
  coord_flip()
```

